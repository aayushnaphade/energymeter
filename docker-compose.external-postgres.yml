services:
  kafka:
    restart: always
    image: bitnamilegacy/kafka:4.0
    ports:
      - "${KAFKA_PORT:-9092}:9092"
      - "9093"
    environment:
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://:9092"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "false"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_NODE_ID: "0"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
      KAFKA_CFG_LOG_RETENTION_MS: "${KAFKA_LOG_RETENTION_MS:-300000}"
      KAFKA_CFG_SEGMENT_BYTES: "${KAFKA_SEGMENT_BYTES:-26214400}"
    volumes:
      - kafka-data:/bitnami
    networks:
      - thingsboard-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  thingsboard-ce:
    restart: always
    image: "thingsboard/tb-node:${TB_VERSION:-4.2.1}"
    ports:
      - "${TB_HTTP_PORT:-8080}:8080"
      - "${TB_EDGE_RPC_PORT:-7070}:7070"
      - "${TB_MQTT_PORT:-1883}:1883"
      - "${TB_MQTT_SSL_PORT:-8883}:8883"
      - "${TB_COAP_PORT_RANGE:-5683-5688}:5683-5688/udp"
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-100m}"
        max-file: "${LOG_MAX_FILE:-10}"
    environment:
      TB_SERVICE_ID: ${TB_SERVICE_ID:-tb-ce-node}
      # External PostgreSQL connection
      # Format: jdbc:postgresql://HOST:PORT/DATABASE
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB:-thingsboard}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TB_QUEUE_TYPE: kafka
      TB_KAFKA_SERVERS: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - thingsboard-network
    volumes:
      - thingsboard-data:/data
      - thingsboard-logs:/var/log/thingsboard

volumes:
  kafka-data:
    name: tb-ce-kafka-data
    driver: local
  thingsboard-data:
    name: tb-ce-data
    driver: local
  thingsboard-logs:
    name: tb-ce-logs
    driver: local

networks:
  thingsboard-network:
    driver: bridge
